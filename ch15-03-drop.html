<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Drop Trait 运行清理代码 | Rust 程序设计语言（中文版）</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Rust 程序设计语言">
    
    <link rel="preload" href="/rust/assets/css/0.styles.f783c941.css" as="style"><link rel="preload" href="/rust/assets/js/app.40d541f7.js" as="script"><link rel="preload" href="/rust/assets/js/2.1042d7dd.js" as="script"><link rel="preload" href="/rust/assets/js/88.10371734.js" as="script"><link rel="prefetch" href="/rust/assets/js/10.edd33632.js"><link rel="prefetch" href="/rust/assets/js/100.0ad946d0.js"><link rel="prefetch" href="/rust/assets/js/101.dbc25b29.js"><link rel="prefetch" href="/rust/assets/js/102.7ba94d76.js"><link rel="prefetch" href="/rust/assets/js/103.cc288c8b.js"><link rel="prefetch" href="/rust/assets/js/104.1980956e.js"><link rel="prefetch" href="/rust/assets/js/105.e1daab00.js"><link rel="prefetch" href="/rust/assets/js/106.ed531c97.js"><link rel="prefetch" href="/rust/assets/js/107.78455384.js"><link rel="prefetch" href="/rust/assets/js/108.8e93e32c.js"><link rel="prefetch" href="/rust/assets/js/109.19f22757.js"><link rel="prefetch" href="/rust/assets/js/11.376b4060.js"><link rel="prefetch" href="/rust/assets/js/110.095a7d5d.js"><link rel="prefetch" href="/rust/assets/js/111.0ee91128.js"><link rel="prefetch" href="/rust/assets/js/112.5fd8a7df.js"><link rel="prefetch" href="/rust/assets/js/113.885e9290.js"><link rel="prefetch" href="/rust/assets/js/114.87dfcbf6.js"><link rel="prefetch" href="/rust/assets/js/115.def2e060.js"><link rel="prefetch" href="/rust/assets/js/12.64ed3f3e.js"><link rel="prefetch" href="/rust/assets/js/13.0d26ee29.js"><link rel="prefetch" href="/rust/assets/js/14.60415b33.js"><link rel="prefetch" href="/rust/assets/js/15.7242e2c2.js"><link rel="prefetch" href="/rust/assets/js/16.9b5245a7.js"><link rel="prefetch" href="/rust/assets/js/17.b314b75e.js"><link rel="prefetch" href="/rust/assets/js/18.e07affd9.js"><link rel="prefetch" href="/rust/assets/js/19.27b67111.js"><link rel="prefetch" href="/rust/assets/js/20.f62b665f.js"><link rel="prefetch" href="/rust/assets/js/21.b72defa0.js"><link rel="prefetch" href="/rust/assets/js/22.d2a936df.js"><link rel="prefetch" href="/rust/assets/js/23.b9e2d931.js"><link rel="prefetch" href="/rust/assets/js/24.08b7ec27.js"><link rel="prefetch" href="/rust/assets/js/25.9d763c7f.js"><link rel="prefetch" href="/rust/assets/js/26.2cd2cb9b.js"><link rel="prefetch" href="/rust/assets/js/27.cb545e35.js"><link rel="prefetch" href="/rust/assets/js/28.c0a80cea.js"><link rel="prefetch" href="/rust/assets/js/29.dc7aa66e.js"><link rel="prefetch" href="/rust/assets/js/3.0cf71ca5.js"><link rel="prefetch" href="/rust/assets/js/30.4512ed10.js"><link rel="prefetch" href="/rust/assets/js/31.4d15a4d7.js"><link rel="prefetch" href="/rust/assets/js/32.05b1d56d.js"><link rel="prefetch" href="/rust/assets/js/33.ae5a07c5.js"><link rel="prefetch" href="/rust/assets/js/34.116008a1.js"><link rel="prefetch" href="/rust/assets/js/35.5b354269.js"><link rel="prefetch" href="/rust/assets/js/36.f27f2f68.js"><link rel="prefetch" href="/rust/assets/js/37.dba8fc27.js"><link rel="prefetch" href="/rust/assets/js/38.1087c819.js"><link rel="prefetch" href="/rust/assets/js/39.bad10f35.js"><link rel="prefetch" href="/rust/assets/js/4.32b65829.js"><link rel="prefetch" href="/rust/assets/js/40.4695233f.js"><link rel="prefetch" href="/rust/assets/js/41.18e89382.js"><link rel="prefetch" href="/rust/assets/js/42.fee2c385.js"><link rel="prefetch" href="/rust/assets/js/43.c4063823.js"><link rel="prefetch" href="/rust/assets/js/44.d093189d.js"><link rel="prefetch" href="/rust/assets/js/45.8eeddd57.js"><link rel="prefetch" href="/rust/assets/js/46.832b5e6a.js"><link rel="prefetch" href="/rust/assets/js/47.9f6416b7.js"><link rel="prefetch" href="/rust/assets/js/48.145f024e.js"><link rel="prefetch" href="/rust/assets/js/49.ade94042.js"><link rel="prefetch" href="/rust/assets/js/5.72ff7d8b.js"><link rel="prefetch" href="/rust/assets/js/50.24344e5b.js"><link rel="prefetch" href="/rust/assets/js/51.0dac9a10.js"><link rel="prefetch" href="/rust/assets/js/52.c8197705.js"><link rel="prefetch" href="/rust/assets/js/53.0b052130.js"><link rel="prefetch" href="/rust/assets/js/54.79733cbf.js"><link rel="prefetch" href="/rust/assets/js/55.a89b7d87.js"><link rel="prefetch" href="/rust/assets/js/56.31966c20.js"><link rel="prefetch" href="/rust/assets/js/57.b86257a0.js"><link rel="prefetch" href="/rust/assets/js/58.0e06d7ab.js"><link rel="prefetch" href="/rust/assets/js/59.cb23df74.js"><link rel="prefetch" href="/rust/assets/js/6.93607226.js"><link rel="prefetch" href="/rust/assets/js/60.56de2678.js"><link rel="prefetch" href="/rust/assets/js/61.ed2571c2.js"><link rel="prefetch" href="/rust/assets/js/62.4978fd70.js"><link rel="prefetch" href="/rust/assets/js/63.e573f90e.js"><link rel="prefetch" href="/rust/assets/js/64.3ac178e7.js"><link rel="prefetch" href="/rust/assets/js/65.d337064e.js"><link rel="prefetch" href="/rust/assets/js/66.96dc0ffe.js"><link rel="prefetch" href="/rust/assets/js/67.aca54fb9.js"><link rel="prefetch" href="/rust/assets/js/68.05029e3a.js"><link rel="prefetch" href="/rust/assets/js/69.044160c7.js"><link rel="prefetch" href="/rust/assets/js/7.d32deb2c.js"><link rel="prefetch" href="/rust/assets/js/70.5454e01d.js"><link rel="prefetch" href="/rust/assets/js/71.e030c5ea.js"><link rel="prefetch" href="/rust/assets/js/72.de7bfec9.js"><link rel="prefetch" href="/rust/assets/js/73.9a2ecbed.js"><link rel="prefetch" href="/rust/assets/js/74.bbd74ab2.js"><link rel="prefetch" href="/rust/assets/js/75.d184f807.js"><link rel="prefetch" href="/rust/assets/js/76.2f2fc478.js"><link rel="prefetch" href="/rust/assets/js/77.838f77db.js"><link rel="prefetch" href="/rust/assets/js/78.846e55b6.js"><link rel="prefetch" href="/rust/assets/js/79.b83fa9ef.js"><link rel="prefetch" href="/rust/assets/js/8.ad267e18.js"><link rel="prefetch" href="/rust/assets/js/80.b9487892.js"><link rel="prefetch" href="/rust/assets/js/81.ee9292a9.js"><link rel="prefetch" href="/rust/assets/js/82.38f08188.js"><link rel="prefetch" href="/rust/assets/js/83.7aaab8c1.js"><link rel="prefetch" href="/rust/assets/js/84.6a0e67e1.js"><link rel="prefetch" href="/rust/assets/js/85.78e6ca4e.js"><link rel="prefetch" href="/rust/assets/js/86.dfb82046.js"><link rel="prefetch" href="/rust/assets/js/87.f4167404.js"><link rel="prefetch" href="/rust/assets/js/89.0a01f554.js"><link rel="prefetch" href="/rust/assets/js/9.889f1565.js"><link rel="prefetch" href="/rust/assets/js/90.c126a47e.js"><link rel="prefetch" href="/rust/assets/js/91.53dadb1d.js"><link rel="prefetch" href="/rust/assets/js/92.3549b67d.js"><link rel="prefetch" href="/rust/assets/js/93.51745a2f.js"><link rel="prefetch" href="/rust/assets/js/94.ee0da9e3.js"><link rel="prefetch" href="/rust/assets/js/95.8844f965.js"><link rel="prefetch" href="/rust/assets/js/96.9edaa201.js"><link rel="prefetch" href="/rust/assets/js/97.a5fa6694.js"><link rel="prefetch" href="/rust/assets/js/98.f21e4069.js"><link rel="prefetch" href="/rust/assets/js/99.fde1e50a.js">
    <link rel="stylesheet" href="/rust/assets/css/0.styles.f783c941.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust/" class="home-link router-link-active"><!----> <span class="site-name">Rust 程序设计语言（中文版）</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/roojay520/trpl-zh-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/rust-lang/book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  The Rust Programming Language
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/KaiserY/trpl-zh-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust 程序设计语言（第二版 &amp; 2018 edition）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rust.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust语言中文社区
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/roojay520/trpl-zh-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/rust-lang/book" target="_blank" rel="noopener noreferrer" class="nav-link external">
  The Rust Programming Language
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/KaiserY/trpl-zh-cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust 程序设计语言（第二版 &amp; 2018 edition）
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://rust.cc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rust语言中文社区
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/rust/" class="sidebar-heading clickable router-link-active open"><span>目录</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>入门指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>基本 Rust 技能</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Rust 编程思想</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-2"><a href="/rust/ch13-00-functional-features" class="sidebar-heading clickable"><span>Rust 中的函数式语言功能：迭代器与闭包</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch13-01-closures.html" class="sidebar-link">闭包：可以捕获环境的匿名函数</a></li><li><a href="/rust/ch13-02-iterators.html" class="sidebar-link">使用迭代器处理元素序列</a></li><li><a href="/rust/ch13-03-improving-our-io-project.html" class="sidebar-link">改进 I/O 项目</a></li><li><a href="/rust/ch13-04-performance.html" class="sidebar-link">性能对比：循环 VS 迭代器</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/rust/ch14-00-more-about-cargo" class="sidebar-heading clickable"><span>更多关于 Cargo 和 Crates.io 的内容</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch14-01-release-profiles.html" class="sidebar-link">采用发布配置自定义构建</a></li><li><a href="/rust/ch14-02-publishing-to-crates-io.html" class="sidebar-link">将 crate 发布到 Crates.io</a></li><li><a href="/rust/ch14-03-cargo-workspaces.html" class="sidebar-link">Cargo 工作空间</a></li><li><a href="/rust/ch14-04-installing-binaries.html" class="sidebar-link">使用 cargo install 从 Crates.io 安装二进制文件</a></li><li><a href="/rust/ch14-05-extending-cargo.html" class="sidebar-link">Cargo 自定义扩展命令</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/rust/ch15-00-smart-pointers" class="sidebar-heading clickable open"><span>智能指针</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch15-01-box.html" class="sidebar-link">使用Box &lt;T&gt;指向堆上的数据</a></li><li><a href="/rust/ch15-02-deref.html" class="sidebar-link">通过 Deref trait 将智能指针当作常规引用处理</a></li><li><a href="/rust/ch15-03-drop.html" aria-current="page" class="active sidebar-link">使用 Drop Trait 运行清理代码</a></li><li><a href="/rust/ch15-04-rc.html" class="sidebar-link">Rc&lt;T&gt; 引用计数智能指针</a></li><li><a href="/rust/ch15-05-interior-mutability.html" class="sidebar-link">RefCell&lt;T&gt; 和内部可变性模式</a></li><li><a href="/rust/ch15-06-reference-cycles.html" class="sidebar-link">引用循环与内存泄漏</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/rust/ch16-00-concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch16-01-threads.html" class="sidebar-link">使用线程同时运行代码</a></li><li><a href="/rust/ch16-02-message-passing.html" class="sidebar-link">使用消息传递在线程间传送数据</a></li><li><a href="/rust/ch16-03-shared-state.html" class="sidebar-link">共享状态并发</a></li><li><a href="/rust/ch16-04-extensible-concurrency-sync-and-send.html" class="sidebar-link">使用 Sync 和 Send trait 的可扩展并发</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><a href="/rust/ch17-00-oop" class="sidebar-heading clickable"><span>Rust 的面向对象编程特性</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust/ch17-01-what-is-oo.html" class="sidebar-link">面向对象语言的特征</a></li><li><a href="/rust/ch17-02-trait-objects.html" class="sidebar-link">为使用不同类型的值而设计的 trait 对象</a></li><li><a href="/rust/ch17-03-oo-design-patterns.html" class="sidebar-link">面向对象设计模式的实现</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>高级主题</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="使用-drop-trait-运行清理代码"><a href="#使用-drop-trait-运行清理代码" class="header-anchor">#</a> 使用 <code>Drop</code> Trait 运行清理代码</h2> <blockquote><p><a href="https://github.com/rust-lang/book/blob/main/src/ch15-03-drop.md" target="_blank" rel="noopener noreferrer">ch15-03-drop.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <br>
commit 57adb83f69a69e20862d9e107b2a8bab95169b4c</p></blockquote> <p>对于智能指针模式来说第二个重要的 trait 是 <code>Drop</code>，其允许我们在值要离开作用域时执行一些代码。可以为任何类型提供 <code>Drop</code> trait 的实现，同时所指定的代码被用于释放类似于文件或网络连接的资源。我们在智能指针上下文中讨论 <code>Drop</code> 是因为其功能几乎总是用于实现智能指针。例如，<code>Box&lt;T&gt;</code> 自定义了 <code>Drop</code> 用来释放 box 所指向的堆空间。</p> <p>在其他一些语言中，我们不得不记住在每次使用完智能指针实例后调用清理内存或资源的代码。如果忘记的话，运行代码的系统可能会因为负荷过重而崩溃。在 Rust 中，可以指定每当值离开作用域时被执行的代码，编译器会自动插入这些代码。于是我们就不需要在程序中到处编写在实例结束时清理这些变量的代码 —— 而且还不会泄漏资源。</p> <p>指定在值离开作用域时应该执行的代码的方式是实现 <code>Drop</code> trait。<code>Drop</code> trait 要求实现一个叫做 <code>drop</code> 的方法，它获取一个 <code>self</code> 的可变引用。为了能够看出 Rust 何时调用 <code>drop</code>，让我们暂时使用 <code>println!</code> 语句实现 <code>drop</code>。</p> <p>示例 15-14 展示了唯一定制功能就是当其实例离开作用域时，打印出 <code>Dropping CustomSmartPointer!</code> 的结构体 <code>CustomSmartPointer</code>。这会演示 Rust 何时运行 <code>drop</code> 函数：</p> <p><span class="filename">文件名: src/main.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">CustomSmartPointer</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">CustomSmartPointer</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping CustomSmartPointer with data `{}`!&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;my stuff&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;other stuff&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointers created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 15-14：结构体 <code>CustomSmartPointer</code>，其实现了放置清理代码的 <code>Drop</code> trait</span></p> <p><code>Drop</code> trait 包含在 prelude 中，所以无需导入它。我们在 <code>CustomSmartPointer</code> 上实现了 <code>Drop</code> trait，并提供了一个调用 <code>println!</code> 的 <code>drop</code> 方法实现。<code>drop</code> 函数体是放置任何当类型实例离开作用域时期望运行的逻辑的地方。这里选择打印一些文本以展示 Rust 何时调用 <code>drop</code>。</p> <p>在 <code>main</code> 中，我们新建了两个 <code>CustomSmartPointer</code> 实例并打印出了 <code>CustomSmartPointer created.</code>。在 <code>main</code> 的结尾，<code>CustomSmartPointer</code> 的实例会离开作用域，而 Rust 会调用放置于 <code>drop</code> 方法中的代码，打印出最后的信息。注意无需显示调用 <code>drop</code> 方法：</p> <p>当运行这个程序，会出现如下输出：</p> <div class="language-text extra-class"><pre class="language-text"><code>CustomSmartPointers created.
Dropping CustomSmartPointer with data `other stuff`!
Dropping CustomSmartPointer with data `my stuff`!
</code></pre></div><p>当实例离开作用域 Rust 会自动调用 <code>drop</code>，并调用我们指定的代码。变量以被创建时相反的顺序被丢弃，所以 <code>d</code> 在 <code>c</code> 之前被丢弃。这个例子刚好给了我们一个 drop 方法如何工作的可视化指导，不过通常需要指定类型所需执行的清理代码而不是打印信息。</p> <h4 id="通过-std-mem-drop-提早丢弃值"><a href="#通过-std-mem-drop-提早丢弃值" class="header-anchor">#</a> 通过 <code>std::mem::drop</code> 提早丢弃值</h4> <p>不幸的是，我们并不能直截了当的禁用 <code>drop</code> 这个功能。通常也不需要禁用 <code>drop</code> ；整个 <code>Drop</code> trait 存在的意义在于其是自动处理的。然而，有时你可能需要提早清理某个值。一个例子是当使用智能指针管理锁时；你可能希望强制运行 <code>drop</code> 方法来释放锁以便作用域中的其他代码可以获取锁。Rust 并不允许我们主动调用 <code>Drop</code> trait 的 <code>drop</code> 方法；当我们希望在作用域结束之前就强制释放变量的话，我们应该使用的是由标准库提供的 <code>std::mem::drop</code>。</p> <p>如果我们像是示例 15-14 那样尝试调用 <code>Drop</code> trait 的 <code>drop</code> 方法，就会得到像示例 15-15 那样的编译错误：</p> <p><span class="filename">文件名: src/main.rs</span></p> <div class="language-rust,ignore,does_not_compile extra-class"><pre class="language-text"><code>fn main() {
    let c = CustomSmartPointer { data: String::from(&quot;some data&quot;) };
    println!(&quot;CustomSmartPointer created.&quot;);
    c.drop();
    println!(&quot;CustomSmartPointer dropped before the end of main.&quot;);
}
</code></pre></div><p><span class="caption">示例 15-15：尝试手动调用 <code>Drop</code> trait 的 <code>drop</code> 方法提早清理</span></p> <p>如果尝试编译代码会得到如下错误：</p> <div class="language-text extra-class"><pre class="language-text"><code>error[E0040]: explicit use of destructor method
  --&gt; src/main.rs:14:7
   |
14 |     c.drop();
   |       ^^^^ explicit destructor calls not allowed
</code></pre></div><p>错误信息表明不允许显式调用 <code>drop</code>。错误信息使用了术语 <strong>析构函数</strong>（<em>destructor</em>），这是一个清理实例的函数的通用编程概念。<strong>析构函数</strong> 对应创建实例的 <strong>构造函数</strong>。Rust 中的 <code>drop</code> 函数就是这么一个析构函数。</p> <p>Rust 不允许我们显式调用 <code>drop</code> 因为 Rust 仍然会在 <code>main</code> 的结尾对值自动调用 <code>drop</code>，这会导致一个 <strong>double free</strong> 错误，因为 Rust 会尝试清理相同的值两次。</p> <p>因为不能禁用当值离开作用域时自动插入的 <code>drop</code>，并且不能显式调用 <code>drop</code>，如果我们需要强制提早清理值，可以使用 <code>std::mem::drop</code> 函数。</p> <p><code>std::mem::drop</code> 函数不同于 <code>Drop</code> trait 中的 <code>drop</code> 方法。可以通过传递希望提早强制丢弃的值作为参数。<code>std::mem::drop</code> 位于 prelude，所以我们可以修改示例 15-15 中的 <code>main</code> 来调用 <code>drop</code> 函数。如示例 15-16 所示：</p> <p><span class="filename">文件名: src/main.rs</span></p> <div class="language-rust extra-class"><pre class="language-rust"><code># <span class="token keyword">struct</span> <span class="token type-definition class-name">CustomSmartPointer</span> <span class="token punctuation">{</span>
#     data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
# <span class="token punctuation">}</span>
#
# <span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">CustomSmartPointer</span> <span class="token punctuation">{</span>
#     <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
#         <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping CustomSmartPointer with data `{}`!&quot;</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
#     <span class="token punctuation">}</span>
# <span class="token punctuation">}</span>
#
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">CustomSmartPointer</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;some data&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer created.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">drop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;CustomSmartPointer dropped before the end of main.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><span class="caption">示例 15-16: 在值离开作用域之前调用 <code>std::mem::drop</code> 显式清理</span></p> <p>运行这段代码会打印出如下：</p> <div class="language-text extra-class"><pre class="language-text"><code>CustomSmartPointer created.
Dropping CustomSmartPointer with data `some data`!
CustomSmartPointer dropped before the end of main.
</code></pre></div><p><code>Dropping CustomSmartPointer with data `some data`!</code> 出现在 <code>CustomSmartPointer created.</code> 和 <code>CustomSmartPointer dropped before the end of main.</code> 之间，表明了 <code>drop</code> 方法被调用了并在此丢弃了 <code>c</code>。</p> <p><code>Drop</code> trait 实现中指定的代码可以用于许多方面，来使得清理变得方便和安全：比如可以用其创建我们自己的内存分配器！通过 <code>Drop</code> trait 和 Rust 所有权系统，你无需担心之后的代码清理，Rust 会自动考虑这些问题。</p> <p>我们也无需担心意外的清理掉仍在使用的值，这会造成编译器错误：所有权系统确保引用总是有效的，也会确保 <code>drop</code> 只会在值不再被使用时被调用一次。</p> <p>现在我们学习了 <code>Box&lt;T&gt;</code> 和一些智能指针的特性，让我们聊聊标准库中定义的其他几种智能指针。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/15/2021, 1:36:56 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust/ch15-02-deref.html" class="prev">
        通过 Deref trait 将智能指针当作常规引用处理
      </a></span> <span class="next"><a href="/rust/ch15-04-rc.html">
        Rc&lt;T&gt; 引用计数智能指针
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/rust/assets/js/app.40d541f7.js" defer></script><script src="/rust/assets/js/2.1042d7dd.js" defer></script><script src="/rust/assets/js/88.10371734.js" defer></script>
  </body>
</html>
